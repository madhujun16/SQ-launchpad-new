// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/database';

// Supabase configuration - use environment variables with fallbacks for production
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL || "https://ngzvoekvwgjinagdvdhf.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nenZvZWt2d2dqaW5hZ2R2ZGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NzE1MzksImV4cCI6MjA2OTM0NzUzOX0.uYNZPJvpIRVBQYrP1JilauuF2evR-vgvSNp3RnnWHGw";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
    storageKey: 'smartq-launchpad-auth',
    detectSessionInUrl: true,
    flowType: 'pkce',
    // Minimal configuration to prevent hanging
    // Enable debug mode in development
    debug: import.meta.env.DEV
  },
  db: {
    schema: 'public'
  },
  // Minimal realtime configuration
  realtime: {
    params: {
      eventsPerSecond: 1 // Minimal
    }
  },
  // Minimal global configuration
  global: {
    headers: {
      'X-Client-Info': 'smartq-launchpad-web'
    }
  }
});

// Add error handling and performance monitoring
supabase.auth.onAuthStateChange((event, session) => {
  console.log('üîç Auth state change:', event, session ? 'Session exists' : 'No session');
  
  if (event === 'SIGNED_OUT') {
    // Clear any cached data on sign out
    localStorage.removeItem('smartq-launchpad-auth');
    console.log('üßπ Cleared auth data on sign out');
  } else if (event === 'TOKEN_REFRESHED') {
    console.log('‚úÖ Token refreshed successfully');
  } else if (event === 'SIGNED_IN') {
    console.log('‚úÖ User signed in successfully');
  }
});

// Simplified session monitoring - removed periodic checks to prevent hanging

// Session initialization helper for better cross-device handling
export const initializeSession = async () => {
  try {
    console.log('üîÑ Initializing session...');
    console.log('üåê Browser:', navigator.userAgent);
    console.log('üîß LocalStorage available:', typeof Storage !== 'undefined');
    
    // Check if localStorage is accessible
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      console.log('‚úÖ LocalStorage is accessible');
    } catch (storageError) {
      console.error('‚ùå LocalStorage error:', storageError);
      return { session: null, error: storageError as Error };
    }
    
    // First, try to get existing session
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.warn('‚ö†Ô∏è Session check error:', error.message);
      
      // If there's an error, try to clear any corrupted session data
      try {
        await supabase.auth.signOut();
        console.log('üßπ Cleared corrupted session data');
      } catch (clearError) {
        console.warn('‚ö†Ô∏è Failed to clear session:', clearError);
      }
      
      return { session: null, error: null };
    }
    
    if (session) {
      console.log('‚úÖ Found existing session');
      return { session, error: null };
    }
    
    console.log('‚ÑπÔ∏è No existing session found - user needs to authenticate');
    console.log('üîÑ This is normal for new devices or after clearing browser data');
    return { session: null, error: null };
    
  } catch (error) {
    console.error('‚ùå Session initialization failed:', error);
    return { session: null, error: error as Error };
  }
};